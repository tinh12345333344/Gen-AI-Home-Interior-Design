from fastapi import APIRouter, UploadFile, File, Form, HTTPException, Query
from fastapi.responses import JSONResponse
from utils.db_client import supabase
from dotenv import load_dotenv
import os
from google import genai
from google.genai import types
import traceback
import base64

load_dotenv()

router = APIRouter()

GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
if not GEMINI_API_KEY:
    raise ValueError("Missing GEMINI_API_KEY in .env")

client = genai.Client(api_key=GEMINI_API_KEY)

@router.get("/designs/all")
async def get_all_designs():
    try:
        result = supabase.table("room_designs").select("id, session_id, created_at, design_metadata, description").order("created_at", desc=True).execute()

        designs = []
        if result.data:
            for design in result.data:
                designs.append({
                    "id": design.get("id"),
                    "session_id": design.get("session_id"),
                    "created_at": design.get("created_at"),
                    "metadata": design.get("design_metadata"),
                    "description": design.get("description")
                })

        return JSONResponse(content={"designs": designs})
    except Exception as e:
        print(f"Error fetching all designs: {e}")
        traceback.print_exc()
        raise HTTPException(status_code=500, detail="Failed to fetch designs")

@router.get("/designs/{session_id}")
async def get_designs_by_session(session_id: str):
    try:
        result = supabase.table("room_designs").select("id, created_at, design_metadata, description").eq("session_id", session_id).order("created_at", desc=True).execute()

        designs = []
        if result.data:
            for design in result.data:
                designs.append({
                    "id": design.get("id"),
                    "created_at": design.get("created_at"),
                    "metadata": design.get("design_metadata"),
                    "description": design.get("description")
                })

        return JSONResponse(content={"designs": designs})
    except Exception as e:
        print(f"Error fetching designs: {e}")
        traceback.print_exc()
        raise HTTPException(status_code=500, detail="Failed to fetch designs")

@router.get("/design/{design_id}/image")
async def get_design_image_by_id(design_id: str):
    try:
        result = supabase.table("room_designs").select("generated_image_data").eq("id", design_id).maybe_single().execute()

        if not result.data:
            raise HTTPException(status_code=404, detail="Design not found")

        image_base64 = result.data.get("generated_image_data")
        if not image_base64:
            raise HTTPException(status_code=404, detail="Image data not found")

        image_url = f"data:image/png;base64,{image_base64}"

        return JSONResponse(content={"image": image_url})
    except HTTPException:
        raise
    except Exception as e:
        print(f"Error fetching design image: {e}")
        traceback.print_exc()
        raise HTTPException(status_code=500, detail="Failed to fetch design image")

@router.get("/designs/{session_id}/{design_id}/image")
async def get_design_image(session_id: str, design_id: str):
    try:
        result = supabase.table("room_designs").select("generated_image_data").eq("id", design_id).eq("session_id", session_id).maybe_single().execute()

        if not result.data:
            raise HTTPException(status_code=404, detail="Design not found")

        image_base64 = result.data.get("generated_image_data")
        if not image_base64:
            raise HTTPException(status_code=404, detail="Image data not found")

        image_url = f"data:image/png;base64,{image_base64}"

        return JSONResponse(content={"image": image_url})
    except HTTPException:
        raise
    except Exception as e:
        print(f"Error fetching design image: {e}")
        traceback.print_exc()
        raise HTTPException(status_code=500, detail="Failed to fetch design image")

@router.post("/rooms/upload")
async def upload_room(
    session_id: str = Form(...),
    room_image: UploadFile = File(...),
    room_description: str = Form("")
):
    try:
        ALLOWED_MIME_TYPES = {"image/jpeg", "image/png", "image/webp", "image/heic", "image/heif"}
        if room_image.content_type not in ALLOWED_MIME_TYPES:
            raise HTTPException(400, "Unsupported file type")

        data = await room_image.read()
        image_b64 = base64.b64encode(data).decode("utf-8")

        result = supabase.table("room_designs").insert({
            "session_id": session_id,
            "generated_image_data": image_b64,
            "description": room_description,
            "design_metadata": {"room_type": "user_uploaded", "style": "custom"}
        }).execute()

        return {"status": "success", "room_id": result.data[0]["id"]}

    except Exception as e:
        raise HTTPException(500, str(e))
    
@router.get("/rooms/all")
async def get_user_rooms(session_id: str = Query(...)):
    try:
        result = supabase.table("room_designs").select(
            "id, session_id, generated_image_data, design_metadata, description, created_at"
        ).eq("session_id", session_id).order("created_at", desc=True).execute()

        rooms = []
        if result.data:
            for r in result.data:
                rooms.append({
                    "id": r.get("id"),
                    "session_id": r.get("session_id"),
                    "image": f"data:image/png;base64,{r.get('generated_image_data')}" if r.get("generated_image_data") else None,
                    "description": r.get("description") or "",
                    "metadata": r.get("design_metadata") or {}
                })

        return JSONResponse({"rooms": rooms})
    except Exception as e:
        print("Error fetching user rooms:", e)
        traceback.print_exc()
        raise HTTPException(status_code=500, detail="Failed to fetch rooms")

@router.post("/furnitures/upload")
async def upload_furniture(
    session_id: str = Form(...),
    furniture_image: UploadFile = File(...),
    furniture_description: str = Form("")
):
    try:
        ALLOWED_MIME_TYPES = {
            "image/jpeg", "image/png", "image/webp",
            "image/heic", "image/heif"
        }

        if furniture_image.content_type not in ALLOWED_MIME_TYPES:
            raise HTTPException(400, "Unsupported file type")

        furniture_bytes = await furniture_image.read()
        furniture_b64 = base64.b64encode(furniture_bytes).decode("utf-8")

        result = supabase.table("furnitures").insert({
            "session_id": session_id,
            "image_base64": furniture_b64,
            "description": furniture_description
        }).execute()

        return {"status": "success", "furniture_id": result.data[0]["id"]}

    except Exception as e:
        raise HTTPException(500, str(e))

@router.post("/place-furniture")
async def place_furniture(
    session_id: str = Form(...),
    design_id: str = Form(None),
    user_room_id: str = Form(None),
    furniture_ids: str = Form(None),
    furniture_images: list[UploadFile] = File([]),
    furniture_descriptions: str = Form("")
):
    try:
        MAX_IMAGE_SIZE_MB = 10
        ALLOWED_MIME_TYPES = {
            "image/jpeg",
            "image/png",
            "image/webp",
            "image/heic",
            "image/heif",
        }

        # --- Prepare furniture images ---
        furniture_bytes_list = []
        furniture_desc_list = []

        # 1. From library
        if furniture_ids:
            ids = [fid.strip() for fid in furniture_ids.split(",") if fid.strip()]
            for fid in ids:
                row = supabase.table("furnitures").select("image_base64, description") \
                    .eq("id", fid).maybe_single().execute()
                if not row.data:
                    continue  # skip invalid IDs
                furniture_bytes_list.append(base64.b64decode(row.data["image_base64"]))
                furniture_desc_list.append(row.data.get("description", "Furniture"))

        # 2. From new uploads
        if furniture_images:
            descs = furniture_descriptions.split(",") if furniture_descriptions else []
            for idx, img in enumerate(furniture_images):
                if img.content_type not in ALLOWED_MIME_TYPES:
                    raise HTTPException(400, f"Unsupported file type: {img.content_type}")
                data = await img.read()
                size_mb = len(data) / (1024*1024)
                if size_mb > MAX_IMAGE_SIZE_MB:
                    raise HTTPException(400, f"Image exceeds {MAX_IMAGE_SIZE_MB}MB")
                furniture_bytes_list.append(data)
                furniture_desc_list.append(descs[idx] if idx < len(descs) else "Furniture")

        if not furniture_bytes_list:
            raise HTTPException(400, "No furniture images provided")

        # === Get or generate room image ===
        room_image_bytes = None
        room_metadata = {}

        if user_room_id:
            room_row = supabase.table("room_designs") \
            .select("*") \
            .eq("id", user_room_id) \
            .maybe_single() \
            .execute()
            
            if not room_row or not room_row.data or not room_row.data.get("generated_image_data"):
                raise HTTPException(404, "User room not found")
            
            # Decode the image
            room_image_bytes = base64.b64decode(room_row.data["generated_image_data"])
            room_metadata = room_row.data.get("design_metadata", {})

        elif design_id:
            # Fetch the design by ID only
            room_row = supabase.table("room_designs").select("*")\
                .eq("id", design_id).maybe_single().execute()

            if not room_row or not room_row.data:
                raise HTTPException(404, "Design not found")

            if not room_row.data.get("generated_image_data"):
                raise HTTPException(404, "Design image not found")

            # Decode the image
            room_image_bytes = base64.b64decode(room_row.data["generated_image_data"])
            room_metadata = room_row.data.get("design_metadata", {})
                
        if not room_image_bytes:
            # Generate neutral empty room
            prompt_empty_room = "Generate a neutral empty room with natural lighting for furniture placement"
            response_empty = client.models.generate_content(
                model="gemini-2.5-flash-image",
                contents=[prompt_empty_room],
                config=types.GenerateContentConfig(response_modalities=["IMAGE"])
            )
            if response_empty.candidates and response_empty.candidates[0].content.parts:
                part = response_empty.candidates[0].content.parts[0]
                if hasattr(part, "inline_data") and part.inline_data:
                    room_image_bytes = part.inline_data.data
                    room_metadata = {"room_type": "empty", "style": "neutral", "design_type": "interior"}
            if not room_image_bytes:
                raise HTTPException(500, "Failed to generate base room image")

        # --- Prepare prompt for AI ---
        furniture_details = "\n".join([f"{i+1}. Description: {d}" for i, d in enumerate(furniture_desc_list)])
        prompt = f"""
You are a professional AI interior designer specializing in furniture placement.

Room context:
- Room Type: {room_metadata.get('room_type', 'unknown')}
- Style: {room_metadata.get('style', 'unknown')}
- Design Type: {room_metadata.get('design_type', 'interior')}

Furniture to place:
{furniture_details}

Task:
- Place all furniture naturally in the room with correct scale, perspective, shadows, and lighting.
- Maintain realism and aesthetic style.

Output:
- A single composite image with all furniture placed.
- A short description of placement for each item.
"""

        # --- Send to AI ---
        contents = [prompt, types.Part.from_bytes(data=room_image_bytes, mime_type="image/png")]
        for fb in furniture_bytes_list:
            contents.append(types.Part.from_bytes(data=fb, mime_type="image/png"))

        response = client.models.generate_content(
            model="gemini-2.5-flash-image",
            contents=contents,
            config=types.GenerateContentConfig(
                response_modalities=['TEXT', 'IMAGE']
            )
        )

        # --- Parse AI output ---
        image_data = None
        text_response = "No description available."
        image_mime_type = "image/png"

        if response.candidates and response.candidates[0].content.parts:
            for part in response.candidates[0].content.parts:
                if hasattr(part, "inline_data") and part.inline_data:
                    image_data = part.inline_data.data
                    image_mime_type = getattr(part.inline_data, "mime_type", "image/png")
                elif hasattr(part, "text") and part.text:
                    text_response = part.text

        if not image_data:
            raise HTTPException(500, "AI failed to generate furniture placement image")

        image_base64 = base64.b64encode(image_data).decode("utf-8")
        image_url = f"data:{image_mime_type};base64,{image_base64}"

        return JSONResponse(content={
            "image": image_url,
            "text": text_response,
            "original_design_id": design_id,
            "user_room_id": user_room_id
        })

    except HTTPException:
        raise
    except Exception as e:
        print(f"Error in furniture placement: {e}")
        traceback.print_exc()
        raise HTTPException(status_code=500, detail="Internal Server Error")
    
    
